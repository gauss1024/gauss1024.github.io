---
import Layout from "@/layouts/Layout.astro";
import "@/editor/style.scss";
import { getPageList, getSinglePageData } from "@/pages/api/post/list";
import config from "urodele.config";

const id = (Astro.params as any).id;
const post = await getSinglePageData(id);
const allPosts = await getPageList();

const curIndex = allPosts.findIndex((p) => p.id === post.id);
const prev = allPosts[curIndex + 1];
const next = allPosts[curIndex - 1];

export const getStaticPaths = async () => {
  const posts = await getPageList(false);
  return posts.map((p) => ({
    params: {
      id: p.id,
    },
  }));
};
---

<script>
  import { mount } from "@/components/Pager";
  import { mount as mountOutline } from "@/components/Outline";

  mount(".navigator", "data-page-id");
  mountOutline(".outline-wrapper");

  const copyIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M7 6V3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1h-3v3c0 .552-.45 1-1.007 1H4.007A1.001 1.001 0 0 1 3 21l.003-14c0-.552.45-1 1.006-1zM5.002 8L5 20h10V8zM9 6h8v10h2V4H9z"/></svg>`;
  const checkIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M10 15.172l9.192-9.193l1.415 1.414L10 18l-6.364-6.364l1.414-1.414z"/></svg>`;

  function addCopyButtons() {
    document.querySelectorAll('.ud-root pre').forEach((pre) => {
      if (pre.querySelector('.copy-code-btn')) return;

      const btn = document.createElement('button');
      btn.className = 'copy-code-btn';
      btn.innerHTML = copyIcon;
      btn.setAttribute('aria-label', 'Copy code');

      btn.addEventListener('click', async () => {
        const code = pre.querySelector('code');
        if (!code) return;
        
        const text = code.innerText;
        try {
          await navigator.clipboard.writeText(text);
          btn.innerHTML = checkIcon;
          btn.classList.add('copied');
          
          setTimeout(() => {
            btn.innerHTML = copyIcon;
            btn.classList.remove('copied');
          }, 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      });

      pre.appendChild(btn);
    });
  }

  addCopyButtons();
</script>

<Layout title={post.title} description={post.intro}>
  <main>
    <div class="content">
      <div class="w-full flex gap-2 pb-2">
        {
          post.tags.map((tag) => (
            <a
              href={`/tag/${encodeURIComponent(tag)}`}
              class="rounded hover:bg-gray-200 dark:hover:bg-modal px-3 py-1 cursor-pointer">
              #{tag}
            </a>
          ))
        }
      </div>
      <div class="ud-root read-only flex-1" set:html={post.html} />

      <div data-page-id={post.id} class="navigator flex justify-between items-center mt-4 py-4">
        {
          prev ? (
            <a href={`/post/${prev.id}`} class="flex items-center gap-1 text-blue cursor-pointer flex-[45%]">
              <div class="i-ri:arrow-left-double-line w-5 h-5 flex-shrink-0" />
              <div class="text-start">{prev.title}</div>
            </a>
          ) : (
            <div />
          )
        }
        {
          next ? (
            <a
              href={`/post/${next.id}`}
              class="flex items-center justify-end gap-1 text-blue cursor-pointer flex-[45%]">
              <div class="text-end">{next.title}</div>
              <div class="i-ri:arrow-right-double-line w-5 h-5 flex-shrink-0" />
            </a>
          ) : (
            <div />
          )
        }
      </div>
    </div>
    <div class="outline-wrapper"></div>
  </main>
  {
    config.giscus && (
      <div class="giscus-container flex justify-center">
        <div class="w-full max-w-[870px] mx-8">
          <script {...config.giscus} />
        </div>
      </div>
    )
  }
</Layout>
